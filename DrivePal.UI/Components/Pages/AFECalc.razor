@using DrivePal.Core.Dtos
@using DrivePal.Core.POCO
@using DrivePal.Core.Services
@using DrivePal.Infrastructure.Services
@using DrivePal.UI.Components.Shared

@using Microsoft.Extensions.DependencyInjection

@inject IServiceProvider ServiceProvider
@inject IDeviceService DeviceService


<div class="row g-4">
	<div class="col-lg-6">
		<div class="card">
			<div class="card-body"> 
				<div  class="p-6  mb-4">
					<h6 class="flex items-center gap-2">
						<CalculatorIcon Size="20" />
						AFE参数
					</h6>
				</div>

				<div class="mb-3">
					<label class="form-label">电机功率配置</label>
					<div class="space-y-3">
						<div class="row align-items-center mb-1">
							<div class="col-sm-3">
								<span>起升</span>
							</div>
							<div class="col-sm-8">
								<input type="number" class="form-control w-100" TValue="decimal?" @bind="@AFE.HoistingPower" @bind:after="() => CalculateMaximumLoad()" Placeholder="输入功率" step="1" />
							</div>
							<div class="col-sm-1 d-flex justify-content-center">
								<input type="checkbox" @bind="@AFE.IncludeHoisting" @bind:after="() => CalculateMaximumLoad()" class="form-check-input" style="width: 20px !important; height: 20px !important; min-width: 20px; min-height: 20px;" />
							</div>
						</div>
							
						<div class="row align-items-center mb-1">
							<div class="col-sm-3">
								<span>大小车</span>
							</div>
							<div class="col-sm-8">
								<input type="number" class="form-control w-100" TValue="decimal?" @bind="@AFE.TrolleyGantryPower" @bind:after="() => CalculateMaximumLoad()" Placeholder="输入功率" step="1" />
							</div>
							<div class="col-sm-1 d-flex justify-content-center">
								<input type="checkbox" @bind="@AFE.IncludeTrolleyGantry" @bind:after="() => CalculateMaximumLoad()" class="form-check-input" style="width: 20px !important; height: 20px !important; min-width: 20px; min-height: 20px;" />
							</div>
						</div>
							
						<div class="row align-items-center mb-1">
							<div class="col-sm-3">
								<span>变幅</span>
							</div>
							<div class="col-sm-8">
								<input type="number" class="form-control w-100" TValue="decimal?" @bind="@AFE.LuffingPower" @bind:after="() => CalculateMaximumLoad()" Placeholder="输入功率" step="1" />
							</div>
							<div class="col-sm-1 d-flex justify-content-center">
								<input type="checkbox" @bind="@AFE.IncludeLuffing" @bind:after="() => CalculateMaximumLoad()" class="form-check-input" style="width: 20px !important; height: 20px !important; min-width: 20px; min-height: 20px;" />
							</div>
						</div>
							
						<div class="row align-items-center mb-1">
							<div class="col-sm-3">
								<span>旋转</span>
							</div>
							<div class="col-sm-8">
								<input type="number" class="form-control w-100" TValue="decimal?" @bind="@AFE.RotatingPower" @bind:after="() => CalculateMaximumLoad()" Placeholder="输入功率" step="1" />
							</div>
							<div class="col-sm-1 d-flex justify-content-center">
								<input type="checkbox" @bind="@AFE.IncludeRotating" @bind:after="() => CalculateMaximumLoad()" class="form-check-input" style="width: 20px !important; height: 20px !important; min-width: 20px; min-height: 20px;" />
							</div>
						</div>
					</div>
				</div>
				
				<div class="mb-3">
					<label class="form-label text-muted">同时工作的最大负载负荷[kW] (自动计算)</label>
					<input type="number" class="form-control form-control-lg" TValue="decimal?" @bind="@AFE.MaximumSimultaneousLoad" disabled step="0.01" />
					<small class="form-text text-muted">根据选中的机构功率自动计算得出</small>
				</div>
				<div class="mb-3">
					<label class="form-label">电机效率</label>
					<input type="number" class="form-control form-control-lg" TValue="decimal?" @bind="@AFE.MotorEfficiency" @bind:event="oninput" min="0" max="1" step="0.01" Placeholder="输入电机效率" />
				</div>
				<div class="mb-3">
					<label class="form-label">逆变器效率</label>
					<input type="number" class="form-control form-control-lg" TValue="decimal?" @bind="@AFE.InverterEfficiency" @bind:event="oninput" min="0" max="1" step="0.01" Placeholder="输入逆变器效率" />
				</div>
				<div class="mb-3">
					<label class="form-label">AFE输入电压 (V)</label>
					<input type="number" class="form-control form-control-lg" TValue="decimal?" @bind="@AFE.AFEInputVoltage" @bind:event="oninput" step="1" Placeholder="输入AFE输入电压" />
				</div>
				<div class="mb-3">
					<label class="form-label">AFE效率</label>
					<input type="number" class="form-control form-control-lg" TValue="decimal?" @bind="@AFE.AFEEfficiency" @bind:event="oninput" min="0" max="1" step="0.01" Placeholder="输入AFE效率" />
				</div>
				<div class="mb-3" style="display:none;">
					<label class="form-label">过载倍数</label>
					<input type="number" class="form-control form-control-lg" TValue="decimal?" @bind="@AFE.OverloadMultiple" @bind:event="oninput" min="1" max="3" step="0.1" Placeholder="输入过载倍数" />
				</div>

				<div class="text-center mt-4">

					<button class="btn btn-primary w-100" @onclick="@(() => HandleCalculation())">
						<i class="fa-solid fa-calculator"></i> 计算变频器容量
					</button>
				</div>
			</div>
		</div>
	</div>
	<div class="col-lg-6">
		<div class="card">
			<div class="card-body">
				<h6 class="card-title mb-4">计算结果</h6>
				@if (AFE.AFEInputCurrent == 0)
				{

					<div class="text-center p-5 text-muted">
						<CalculatorIcon Size="60" Color="lightgray" />
						<p class="mt-4" style="color:lightgray">请填入参数并点击计算按钮</p>
					</div>
				}
				else
				{
					<div class="row g-3 mb-4">
						<div class="col">
							<div class="bg-body-secondary rounded p-3 text-center">
								<span class="text-muted small">AFE最大负荷[KW]</span>
								<h4 class="fw-bold mb-0">@AFE.AFEMaximumLoad.ToString("F2") kW</h4>
							</div>
						</div>
						<div class="col">
							<div class="bg-body-secondary rounded p-3 text-center">
								<span class="text-muted small">AFE输入电流</span>
								<h4 class="fw-bold mb-0">@AFE.AFEInputCurrent.ToString("F2") A</h4>
							</div>
						</div>
					</div> 

					<div class="mb-4">
						<h6 class="fw-bold small">AFE电流要求</h6>
						<p class="mb-1">要求: I_inv ≥ @AFE.AFEInputCurrent.ToString("F2") A</p>
					</div>
					<div class="border rounded p-3 d-flex align-items-center">
						<i class="fa-solid fa-circle-info fa-lg me-3"></i>
						<div class="flex-grow-1">
							推荐AFE单元容量:
							<span class="badge text-bg-dark rounded-pill fs-6">@PowerResultText</span>
						</div>
					</div>



					@if (recommendedInverters != null && recommendedInverters.Any())
					{
						<div class="mt-4 overflow-x-auto">
							<h6 class="fw-bold small mb-2">详细推荐列表</h6>
							<table class="table table-striped table-bordered">
								<thead>
									<tr>
										<th>型号</th>
										<th>功率 (kW)</th>
										<th>交流额定电流 (A)</th>
									</tr>
								</thead>
								<tbody>
									@foreach (var inverter in recommendedInverters)
									{
										<tr>
											<td>@inverter.Variant</td>
											<td>@inverter.Power</td>
											<td>@inverter.RatedCurrent</td>
										</tr>
									}
								</tbody>
							</table>
						</div>
					}
				}
			</div>
		</div>
	</div>
</div>

@code {

	// 页面初始值 - 已移至_afe私有字段

	public string PowerResultText { get; set; }
	private List<RecommendedInverterDto>? recommendedInverters;
	private NetPowerFilterCriteria searchCriteria;
	public bool IsScanning { get; set; } = false;

	// 计算最大负载负荷的方法
	private void CalculateMaximumLoad()
	{
		// 计算选中机构的总功率
		decimal totalPower = 0;
		if (AFE.IncludeHoisting && AFE.HoistingPower.HasValue)
		{
			totalPower += AFE.HoistingPower.Value;
		}
		if (AFE.IncludeTrolleyGantry && AFE.TrolleyGantryPower.HasValue)
		{
			totalPower += AFE.TrolleyGantryPower.Value;
		}
		if (AFE.IncludeLuffing && AFE.LuffingPower.HasValue)
		{
			totalPower += AFE.LuffingPower.Value;
		}
		if (AFE.IncludeRotating && AFE.RotatingPower.HasValue)
		{
			totalPower += AFE.RotatingPower.Value;
		}
		
		// 更新最大负载负荷
		_afe.MaximumSimultaneousLoad = totalPower;
		StateHasChanged();
	}



	private AFEMechanism _afe = new()
	{
		MaximumSimultaneousLoad = 300m,
		HoistingPower = 200m,
		IncludeHoisting = true,
		TrolleyGantryPower = 50m,
		IncludeTrolleyGantry = true,
		LuffingPower = 30m,
		IncludeLuffing = true,
		RotatingPower = 20m,
		IncludeRotating = true,
		MotorEfficiency = 0.88m,
		InverterEfficiency = 0.97m,
		AFEInputVoltage = 380m,
		AFEEfficiency = 0.98m, 
		OverloadMultiple = 1.00m
	};

	// 使用属性访问器来捕获变化并触发计算
	private AFEMechanism AFE
	{
		get => _afe;
		set 
		{ 
			_afe = value;
		}
	}

	protected override void OnInitialized()
	{
		base.OnInitialized();
	}


	private async Task HandleCalculation()
	{

		_afe.PerformCalculation(GetStrategy());
		searchCriteria = _afe.ToDeviceSearchCriteria() as NetPowerFilterCriteria;

		recommendedInverters = await DeviceService.GetSuitableInvertersByCurrentAsync(searchCriteria);

		// 刷新结果到UI
		if (recommendedInverters != null && recommendedInverters.Count > 0)
		{
			var recommendedDevice = recommendedInverters.First();
			PowerResultText = $"{recommendedDevice.Power}kW";
		}
		else
		{
			PowerResultText = "无合适设备推荐";
		}

		StateHasChanged();
	}


	private IMechanismCalculationStrategy GetStrategy()
	{
		return ServiceProvider.GetRequiredKeyedService<IMechanismCalculationStrategy>("afe");
	}
}

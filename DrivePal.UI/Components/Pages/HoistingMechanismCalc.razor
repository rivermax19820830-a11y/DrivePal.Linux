@using DrivePal.Core.Dtos
@using DrivePal.Core.Enums
@using DrivePal.Core.Models
@using DrivePal.Core.POCO
@using DrivePal.Core.Services
@using DrivePal.UI.Components.Shared
@using Microsoft.Extensions.DependencyInjection
@inject IServiceProvider ServiceProvider

@inject IDeviceService DeviceService


<div class="row g-4">
	<div class="col-lg-6">
		<div class="card">
			<div class="card-body">
				<div class="p-6 mb-4">
					<h6 class="flex items-center gap-2">
						<CalculatorIcon Size="20" />
						起升机构参数
					</h6>
				</div>

				<div class="mb-3 tb-3">
					<label class="form-label">最大起重量 (t)</label>
					<input type="number" class="form-control form-control-lg" TValue="decimal?" @bind="@hoistingMechanism.LoadWeight_t" Placeholder="输入最大起重重量" step="0.01" />
				</div>
				<div class="mb-3">
					<label class="form-label">吊具重量 (t)</label>
					<input type="number" class="form-control form-control-lg" TValue="decimal?" @bind="@hoistingMechanism.SpreaderWeight_t" Placeholder="输入吊具或吊钩重量" step="0.01" />
				</div>
				<div class="mb-3">
					<label class="form-label">额定起升速度 (m/min)</label>
					<input type="number" class="form-control form-control-lg" TValue="decimal?" @bind="@hoistingMechanism.LiftingSpeed_m_per_min" Placeholder="输入电机额定转速时的起升速度" />
				</div>
				<div class="mb-3">
					<label class="form-label">传动效率</label>
					<input type="number" class="form-control form-control-lg" TValue="decimal?" @bind="@hoistingMechanism.TransmissionEfficiency" min="0" max="1" step="0.01" Placeholder="" />
				</div>
				<div class="mb-3" />



				<div class="mb-3">
					<label class="form-label">传动类型</label>
					<div class="d-flex gap-4">
						<div class="form-check">
							<input type="radio" id="hoist_singleDrive" name="hoist_driveType" class="form-check-input"
								   value="Single" @onchange="HandleDriveTypeChange" checked="@(SelectedDriveType == DriveTypeSelection.SingleDrive)" />
							<label class="form-check-label" for="hoist_singleDrive">单传动变频器(400V)</label>
						</div>
						<div class="form-check">
							<input type="radio" id="hoist_multiDrive" name="hoist_driveType" class="form-check-input"
								   value="Multi" @onchange="HandleDriveTypeChange" checked="@(SelectedDriveType == DriveTypeSelection.MultiDriveSystem)" />
							<label class="form-check-label" for="hoist_multiDrive">多传动(400V)</label>
						</div>
					</div>
				</div>


				<div class="mb-3">
					<label class="form-label">电机数量</label>
					<input type="number" class="form-control form-control-lg" TValue="int" @bind="@hoistingMechanism.MotorCount" min="1" max="99" step="1" />
				</div>


				<div class="mb-3">
					<label class="form-label">电机额定电压 (V)</label>
					<input type="number" class="form-control form-control-lg" TValue="decimal" @bind="@hoistingMechanism.Motor.RatedVoltage" step="1" Placeholder="例如: 380" />
				</div>
				<div class="mb-3">
					<label class="form-label">功率因数 (cos φ)</label>
					<input type="number" class="form-control form-control-lg" TValue="decimal" @bind="@hoistingMechanism.Motor.PowerFactor" min="0" max="1" step="0.01" Placeholder="港口设备: 0.78 - 0.85" />
				</div>
				<div class="mb-3">
					<label class="form-label">高过载电流倍数</label>
					<input type="number" class="form-control form-control-lg" TValue="decimal" @bind="@hoistingMechanism.OverloadMultiple" min="1" max="10" step="0.01" Placeholder="推荐: 1.8 - 2" />
				</div>


				<button class="btn btn-primary w-100" @onclick="@(() => HandleCalculation())">
					<i class="fa-solid fa-calculator"></i> 计算变频器容量
				</button>
			</div>
			</div>
	</div>
	<div class="col-lg-6">
		<div class="card">
			<div class="card-body">
				<h6 class="card-title mb-4">计算结果</h6>
				@if (hoistingMechanism.RequiredCurrent == null)
				{

					<div class="text-center p-5 text-muted">
						<CalculatorIcon Size="60" Color="lightgray" />
						<p class="mt-4" style="color:lightgray">请填入参数并点击计算按钮</p>
					</div>
				}
				else
				{
					if (CalculatedDriveType == DriveTypeSelection.SingleDrive)
					{
						<div class="row g-3 mb-4">
							<div class="col">
								<div class="bg-body-secondary rounded p-3 text-center">
									<span class="text-muted small">净功率</span>
									<h4 class="fw-bold mb-0">@hoistingMechanism.SingleNetPower.ToString("F2") kW</h4>
								</div>
							</div>
							<div class="col">
								<div class="bg-body-secondary rounded p-3 text-center">
									<span class="text-muted small">负载电流</span>
									<h4 class="fw-bold mb-0">@hoistingMechanism.LoadCurrent.ToString("F2") A</h4>
								</div>
							</div>
						</div>
						<div class="mb-4">
							<h6 class="fw-bold small">变频器电流要求</h6>
							<p class="mb-1">要求1: I_inv ≥ @hoistingMechanism.RatedCurrentCondition1.ToString("F2") A</p>
							<p class="mb-1">要求2: I_inv ≥ @hoistingMechanism.RatedCurrentCondition2.ToString("F2") A</p>
						</div>
						<div class="border rounded p-3 d-flex align-items-center">
							<i class="fa-solid fa-circle-info fa-lg me-3"></i>
							<div class="flex-grow-1">
								推荐变频器容量:
								<span class="badge text-bg-dark rounded-pill fs-6">@PowerResultText</span>
							</div>
						</div>


						@if (recommendedInverters != null && recommendedInverters.Any())
						{

							<div class="mt-4 overflow-x-auto">
								<h6 class="fw-bold small mb-2">详细推荐列表</h6>
								<table class="table table-striped table-bordered">
									<thead>
										<tr>
											<th>型号</th>
											<th>功率 (kW)</th>
											<th>额定电流 (A)</th>
										</tr>
									</thead>
									<tbody>
										@foreach (var inverter in recommendedInverters)
										{
											<tr>
												<td>@inverter.Variant</td>
												<td>@inverter.Power</td>
												<td>@inverter.RatedCurrent</td>
											</tr>
										}
									</tbody>
								</table>
							</div>
						}
					}
					else
					{

						<div class="row g-3 mb-4">
							<div class="col">
								<div class="bg-body-secondary rounded p-3 text-center">
									<span class="text-muted small">单台净功率</span>
									<h4 class="fw-bold mb-0">@hoistingMechanism.SingleNetPower.ToString("F2") kW</h4>
								</div>
							</div>
							<div class="col">
								<div class="bg-body-secondary rounded p-3 text-center">
									<span class="text-muted small">单台负载电流</span>
									<h4 class="fw-bold mb-0">@hoistingMechanism.LoadCurrent.ToString("F2") A</h4>
								</div>
							</div>
						</div>
						<div class="mb-4">
							<h6 class="fw-bold small">变频器电流要求</h6>
							<p class="mb-1">要求1: I_inv ≥ @hoistingMechanism.RatedCurrentCondition1.ToString("F2") A</p>
							<p class="mb-1">要求2: I_inv ≥ @hoistingMechanism.RatedCurrentCondition2.ToString("F2") A</p>
						</div>
						<div class="border rounded p-3 d-flex align-items-center">
							<i class="fa-solid fa-circle-info fa-lg me-3"></i>
							<div class="flex-grow-1">
								推荐变频器容量:
								<span class="badge text-bg-dark rounded-pill fs-6">@PowerResultText</span>

							</div>
						</div>


						@if (recommendedInverters != null && recommendedInverters.Any())
						{
							<div class="mt-4 overflow-x-auto">
								<h6 class="fw-bold small mb-2">详细推荐列表</h6>
								<table class="table table-striped table-bordered">
									<thead>
										<tr>
											<th>型号</th>
											<th>功率 (kW)</th>
											<th>额定电流 (A)</th>
											<th>最大过载电流 (A)</th>
										</tr>
									</thead>
									<tbody>
										@foreach (var inverter in recommendedInverters)
										{
											<tr>
												<td>@inverter.Variant</td>
												<td>@inverter.Power</td>
												<td>@inverter.RatedCurrent</td>
												<td>@inverter.MaxOverloadCurrent</td>
											</tr>
										}
									</tbody>
								</table>
							</div>
						}
					}
				}
			</div>
		</div>
	</div>
</div>

@code {
	/// <summary>
	/// 参数中的传动类型
	/// </summary>
	private DriveTypeSelection SelectedDriveType
	{
		get; set;
	} = DriveTypeSelection.SingleDrive;

	/// <summary>
	/// 计算结果用的传动类型
	/// </summary>
	private DriveTypeSelection CalculatedDriveType { get; set; } = DriveTypeSelection.SingleDrive;

	public string PowerResultText { get; set; }


	// 页面初始值
	private HoistingMechanism hoistingMechanism = new()
	{
		LoadWeight_t = 40.5m,
		SpreaderWeight_t = 12.5m,
		LiftingSpeed_m_per_min = 20.0m,
		TransmissionEfficiency = 0.88m,
		IsMultidrive = false,
		MotorCount = 1,
		Motor = new MotorParameters
		{
			RatedVoltage = 380,
			PowerFactor = 0.83m,
			RatedFrequency = 50m,
			Efficiency = 0.88m,
			OperatingFrequency = 42m,
		},
		OverloadMultiple = 1.8m
	};
	private List<RecommendedInverterDto>? recommendedInverters;

	private async Task HandleCalculation()
	{
		// 收集参数
		hoistingMechanism.IsMultidrive = (this.SelectedDriveType == DriveTypeSelection.MultiDriveSystem);
		CalculatedDriveType = SelectedDriveType;


		// 1. 让模型自己计算自己
		hoistingMechanism.PerformCalculation(GetStrategy());

		// 2. 让模型自己生成查询条件
		var searchCriteria = hoistingMechanism.ToDeviceSearchCriteria() as NetPowerFilterCriteria;

		// 3. 调用服务
		recommendedInverters = await DeviceService.GetSuitableInvertersByCurrentAsync(searchCriteria);

		// 刷新结果到UI
		if (recommendedInverters != null && recommendedInverters.Count > 0)
		{
			var recommendedDevice = recommendedInverters.First();
			PowerResultText = $"{recommendedDevice.Power}kW";
		}
		else
		{
			PowerResultText = "无合适设备推荐";
		}


		StateHasChanged();
	}

	private void HandleDriveTypeChange(ChangeEventArgs e)
	{
		if (e.Value != null)
		{
			if (e.Value.ToString() == "Single")
			{
				SelectedDriveType = DriveTypeSelection.SingleDrive;
			}
			else if (e.Value.ToString() == "Multi")
			{
				SelectedDriveType = DriveTypeSelection.MultiDriveSystem;
			}
		}

		hoistingMechanism.IsMultidrive = (this.SelectedDriveType == DriveTypeSelection.MultiDriveSystem);
	}


	private IMechanismCalculationStrategy GetStrategy()
	{
		return ServiceProvider.GetRequiredKeyedService<IMechanismCalculationStrategy>("hoist");
	}

}